<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ToolHub - Tool</title>
    <link rel="stylesheet" href="/style.css" />
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  	<style>
  	/* Anti-flicker per pagina tool */
  	body.preload .navbar,
  	body.preload .tool-shell,
  	body.preload footer { opacity:0; }
  	body.app-ready .navbar,
  	body.app-ready .tool-shell,
  	body.app-ready footer { opacity:1; transition:opacity .25s ease; }
  	</style>
  </head>
  <body class="preload">
    <nav class="navbar">
      <a class="logo" href="/index.html" title="Torna alla Home">ToolHub</a>
      <ul class="navlinks">
        <li><a href="/">Home</a></li>
        <li><a href="/index.html#tools">Tools</a></li>
        <li><a href="/index.html#prossimamente">Prossimamente</a></li>
        <li><a href="/index.html#contact">Contatti</a></li>
      </ul>
    </nav>
  <main style="padding-top:30px;max-width:960px;margin:0 auto" class="tool-shell">
      <div id="tool-root"></div>
    </main>
    <footer style="margin-top:60px"><div>Â© ToolHub</div></footer>
    <script type="text/babel" src="/tools/PdfJpgTool.js"></script>
    <script type="text/babel" src="/tools/BmiTool.js"></script>
    <script type="text/babel" src="/tools/QuoteTool.js"></script>
    <script type="text/babel" src="/tools/FlashcardTool.js"></script>
    <script type="text/babel" src="/tools/TaxesTool.js"></script>
    <script type="text/babel" src="/tools/PreventivoTool.js"></script>
    <script type="text/babel">
      function resolveComponent(finalKey){
        const map = { pdfjpg: window.PdfJpgTool, bmi: window.BmiTool, quote: window.QuoteTool, flashcard: window.FlashcardTool, taxes: window.TaxesTool, preventivo: window.PreventivoTool };
        return map[finalKey];
      }
      function start(){
        const params = new URLSearchParams(location.search);
        const raw = params.get('tool');
        const validListHtml = '<ul style="margin:8px 0 0;padding-left:18px;font-size:12px;line-height:1.4">'+
          '<li>?tool=pdfjpg</li><li>?tool=bmi</li><li>?tool=quote (alias: preventivo, preventivi)</li><li>?tool=flashcard</li><li>?tool=taxes</li></ul>';
        const root = document.getElementById('tool-root');
        if(!raw){
          root.innerHTML = '<div class="card"><strong>Nessun tool selezionato.</strong><br />Aggiungi il parametro ?tool= nella URL.'+validListHtml+'</div>';
          return;
        }
        const key = raw.trim().toLowerCase();
        const alias = { 'preventivi-pdf':'quote','preventivo-pdf':'quote','quotepdf':'quote','preventivi_pdf':'quote' };
        const direct = { 'preventivo':'preventivo', 'preventivi':'preventivo' };
        const finalKey = direct[key] || alias[key] || key;
        root.innerHTML = '<div class="card" id="loading-card">Caricamento tool <span style="font-size:11px;opacity:.6">('+finalKey+')</span>...</div>';
        let attempts = 0;
        const maxTime = 10000; // 10s max
        let delay = 100;
        const started = performance.now();

        function markReady(){ document.body.classList.remove('preload'); document.body.classList.add('app-ready'); }
        function tryMount(){
          const Comp = resolveComponent(finalKey);
          if(Comp){
            ReactDOM.render(React.createElement('div', {className:'tool-panel'}, React.createElement(Comp)), root);
            markReady();
            return true;
          }
          if(performance.now() - started >= maxTime){
            root.innerHTML = '<div class="card"><strong>Tool non trovato:</strong> '+finalKey+'<br />Verifica il parametro oppure scegli uno di questi:'+validListHtml+'<div style="margin-top:10px"><button id="retryBtn" class="btn">Riprova</button></div><div style="margin-top:6px;font-size:11px;opacity:.6">Potrebbe essere cache: prova hard refresh (CTRL+F5).</div></div>';
            const rb = document.getElementById('retryBtn');
            if(rb) rb.addEventListener('click', ()=>{ root.innerHTML='<div class="card">Retry in corso...</div>'; attempts=0; delay=100; setTimeout(loop,50); });
            injectMissing(finalKey);
            markReady();
            return true;
          }
          return false;
        }

        function injectMissing(fk){
          const mapSrc = { pdfjpg:'/tools/PdfJpgTool.js', bmi:'/tools/BmiTool.js', quote:'/tools/QuoteTool.js', flashcard:'/tools/FlashcardTool.js', taxes:'/tools/TaxesTool.js', preventivo:'/tools/PreventivoTool.js' };
          if(!resolveComponent(fk) && mapSrc[fk] && !document.querySelector('script[data-dynamic="'+fk+'"]')){
            const s = document.createElement('script'); s.type='text/babel'; s.src = mapSrc[fk]; s.setAttribute('data-dynamic', fk); document.body.appendChild(s);
          }
        }

        function loop(){
          attempts++;
          if(tryMount()) return;
          delay = Math.min(1000, delay*1.3);
          setTimeout(loop, delay);
        }
        loop();
      }
      if(document.readyState === 'complete' || document.readyState === 'interactive'){
        setTimeout(start, 0);
      } else {
        window.addEventListener('load', start);
      }
    </script>
  </body>
</html>
